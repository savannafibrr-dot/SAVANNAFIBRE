<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Locations - Savanna Fibre</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .navbar-brand img {
            height: 40px;
            width: auto;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .location-search {
            position: relative;
            margin-bottom: 1rem;
        }
        .location-search input {
            padding-right: 40px;
        }
        .location-search .btn {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            border-radius: 0 8px 8px 0;
        }
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
        }
        .map-controls .btn {
            margin-bottom: 5px;
            background: white;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .map-controls .btn:hover {
            background: #f8f9fa;
        }
        .address-details {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .address-details .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .address-details .form-control {
            background: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <img src="/images/logo.png" alt="Savanna Fibre">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">
                            <i class="bi bi-speedometer2 me-2"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/plans.html">
                            <i class="bi bi-wifi me-2"></i>
                            Internet Plans
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/shops.html">
                            <i class="bi bi-shop me-2"></i>
                            Shop Locations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/coverage.html">
                            <i class="bi bi-broadcast-pin me-2"></i>
                            Coverage Areas
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logout-btn">
                            <i class="bi bi-box-arrow-right me-2"></i>
                            Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div>
                <h1 class="h3 mb-1">Shop Locations</h1>
                <p class="text-secondary mb-0">Manage your shop locations</p>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#shopModal">
                <i class="bi bi-plus-lg me-2"></i>
                Add New Shop
            </button>
        </div>

        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th>SHOP NAME</th>
                                <th>ADDRESS</th>
                                <th>CITY</th>
                                <th>CONTACT</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="shops-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Shop Modal -->
    <div class="modal fade" id="shopModal" tabindex="-1" role="dialog" aria-labelledby="modalTitle">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add New Shop</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger d-none" id="errorAlert"></div>
                    <form id="shopForm" novalidate>
                        <div class="mb-3">
                            <label class="form-label">Shop Name</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-shop"></i>
                                </span>
                                <input type="text" class="form-control" id="shopName" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Location</label>
                            <div class="location-search">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-geo-alt"></i>
                                    </span>
                                    <input type="text" class="form-control" id="locationSearch" 
                                        placeholder="Search for a location or click 'Use My Location'">
                                    <button type="button" class="btn btn-outline-secondary" id="useMyLocation">
                                        <i class="bi bi-geo-alt-fill"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="map"></div>
                            <div class="map-controls">
                                <button type="button" class="btn btn-light" id="resetMap">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                            </div>
                        </div>
                        <div class="address-details">
                            <div class="mb-3">
                                <label class="form-label">Street Address</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-geo"></i>
                                    </span>
                                    <input type="text" class="form-control" id="streetAddress" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">City</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-building"></i>
                                    </span>
                                    <input type="text" class="form-control" id="city" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contact Number</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-telephone"></i>
                                </span>
                                <input type="tel" class="form-control" id="contactNumber" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveShopBtn">
                        <span class="spinner-border spinner-border-sm d-none me-2"></span>
                        Save Shop
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Maps API -->
    <script>
        // Load Google Maps API with the correct API key
        const script = document.createElement('script');
        script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBV7cqwH-DW9ICtLYjnhV3v_1teQyotZzA&libraries=places,marker&loading=async&callback=initMap';
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentShopId = null;
        let map;
        let marker;
        let geocoder;
        let autocomplete;
        const shopModal = new bootstrap.Modal(document.getElementById('shopModal'));

        // Initialize Google Maps
        async function initMap() {
            try {
                // Default center (Tanzania)
                const defaultCenter = { lat: -6.369028, lng: 34.888822 };
                
                // Initialize map with Map ID
                map = new google.maps.Map(document.getElementById('map'), {
                    center: defaultCenter,
                    zoom: 6,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false,
                    mapId: "YOUR_MAP_ID" // Replace with your actual Map ID
                });

                // Initialize geocoder
                geocoder = new google.maps.Geocoder();

                // Initialize autocomplete with PlaceAutocompleteElement
                const input = document.getElementById('locationSearch');
                const autocompleteElement = new google.maps.places.PlaceAutocompleteElement({
                    inputElement: input,
                    componentRestrictions: { country: 'tz' },
                    types: ['address']
                });
                document.getElementById('locationSearch').parentElement.appendChild(autocompleteElement);

                // Initialize marker with AdvancedMarkerElement
                marker = new google.maps.marker.AdvancedMarkerElement({
                    map,
                    position: defaultCenter,
                    title: "Shop Location",
                    gmpDraggable: true
                });

                // Listen for place selection using the new event
                autocompleteElement.addEventListener('gmp-placechange', () => {
                    const place = autocompleteElement.value;
                    if (!place || !place.location) return;

                    // Update map
                    map.setCenter(place.location);
                    map.setZoom(15);

                    // Update marker
                    marker.position = place.location;

                    // Update address fields
                    updateAddressFields(place);
                });

                // Listen for marker drag
                marker.addEventListener('dragend', () => {
                    const position = marker.position;
                    geocoder.geocode({ location: position }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            updateAddressFields(results[0]);
                        }
                    });
                });

                // Listen for map click
                map.addListener('click', (event) => {
                    marker.position = event.latLng;
                    geocoder.geocode({ location: event.latLng }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            updateAddressFields(results[0]);
                        }
                    });
                });

                // Add info window for better UX
                const infoWindow = new google.maps.InfoWindow({
                    content: "Drag marker to adjust location"
                });

                marker.addEventListener('mouseover', () => {
                    infoWindow.open(map, marker);
                });

                marker.addEventListener('mouseout', () => {
                    infoWindow.close();
                });

                // Request location permission and get current location
                requestLocationPermission();

            } catch (error) {
                console.error('Error initializing map:', error);
                alert('Error loading Google Maps. Please check your API key and billing status.');
            }
        }

        // Request location permission
        async function requestLocationPermission() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }

            try {
                const permissionResult = await navigator.permissions.query({ name: 'geolocation' });
                
                if (permissionResult.state === 'granted') {
                    // Permission already granted
                    await getCurrentLocation();
                } else if (permissionResult.state === 'prompt') {
                    // Show custom permission request UI
                    const permissionDialog = document.createElement('div');
                    permissionDialog.className = 'alert alert-info mt-2';
                    permissionDialog.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span>This app needs your location to find nearby shops. Would you like to share your location?</span>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-primary" onclick="getCurrentLocation()">Allow</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Deny</button>
                            </div>
                        </div>
                    `;
                    document.getElementById('map').parentElement.appendChild(permissionDialog);
                } else {
                    // Permission denied
                    const deniedMessage = document.createElement('div');
                    deniedMessage.className = 'alert alert-warning mt-2';
                    deniedMessage.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Location access is denied. You can enable it in your browser settings or search for a location manually.</span>
                            <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                        </div>
                    `;
                    document.getElementById('map').parentElement.appendChild(deniedMessage);
                }
            } catch (error) {
                console.error('Error requesting location permission:', error);
                // Fallback to manual location selection
                const fallbackMessage = document.createElement('div');
                fallbackMessage.className = 'alert alert-info mt-2';
                fallbackMessage.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Please search for a location or click on the map to set the shop location.</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                    </div>
                `;
                document.getElementById('map').parentElement.appendChild(fallbackMessage);
            }
        }

        // Get current location and update map
        async function getCurrentLocation() {
            if (navigator.geolocation) {
                try {
                    // Show loading message
                    const loadingMessage = document.createElement('div');
                    loadingMessage.className = 'alert alert-info mt-2';
                    loadingMessage.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Searching for precise location...</span>
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    `;
                    document.getElementById('map').parentElement.appendChild(loadingMessage);

                    // Remove permission dialog if exists
                    const permissionDialog = document.querySelector('.alert-info');
                    if (permissionDialog) {
                        permissionDialog.remove();
                    }

                    // Get current position with high accuracy
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            // Log location details for debugging
                            console.log('Latitude:', position.coords.latitude);
                            console.log('Longitude:', position.coords.longitude);
                            console.log('Accuracy:', position.coords.accuracy, 'meters');
                            console.log('Altitude:', position.coords.altitude);
                            console.log('Altitude Accuracy:', position.coords.altitudeAccuracy);
                            console.log('Heading:', position.coords.heading);
                            console.log('Speed:', position.coords.speed);

                            // Update map with high zoom level for precision
                            map.setCenter(pos);
                            map.setZoom(18);

                            // Update marker with precise position
                            if (marker) {
                                marker.position = pos;
                            }

                            // Get address details
                            geocoder.geocode({ 
                                location: pos
                            }, (results, status) => {
                                if (status === 'OK' && results[0]) {
                                    updateAddressFields(results[0]);
                                    // Update search input with formatted address
                                    document.getElementById('locationSearch').value = results[0].formatted_address;
                                }
                            });

                            // Remove loading message
                            loadingMessage.remove();
                            
                            // Show accuracy message with detailed information
                            const accuracyMessage = document.createElement('div');
                            accuracyMessage.className = 'alert alert-success mt-2';
                            accuracyMessage.innerHTML = `
                                <div class="d-flex flex-column">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Location found with accuracy: ${Math.round(position.coords.accuracy)}m</span>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                                    </div>
                                    <small class="text-muted">
                                        If accuracy is low, try:
                                        <ul class="mb-0">
                                            <li>Enabling precise location in your phone settings</li>
                                            <li>Opening Google Maps first to calibrate GPS</li>
                                            <li>Moving to an open area with clear sky view</li>
                                        </ul>
                                    </small>
                                </div>
                            `;
                            document.getElementById('map').parentElement.appendChild(accuracyMessage);
                        },
                        (error) => {
                            // Remove loading message
                            loadingMessage.remove();
                            
                            console.error('Error getting location:', error);
                            
                            // Show detailed error message with troubleshooting tips
                            const errorMessage = document.createElement('div');
                            errorMessage.className = 'alert alert-danger mt-2';
                            errorMessage.innerHTML = `
                                <div class="d-flex flex-column">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Error getting your location</span>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                                    </div>
                                    <small class="text-muted">
                                        Troubleshooting tips:
                                        <ul class="mb-0">
                                            <li>Enable location services in your browser settings</li>
                                            <li>Enable precise location in your phone settings</li>
                                            <li>Try opening Google Maps first to calibrate GPS</li>
                                            <li>Move to an open area with clear sky view</li>
                                            <li>Or search for a location manually</li>
                                        </ul>
                                    </small>
                                </div>
                            `;
                            document.getElementById('map').parentElement.appendChild(errorMessage);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 20000,
                            maximumAge: 0
                        }
                    );
                } catch (error) {
                    console.error('Error in getCurrentLocation:', error);
                }
            }
        }

        // Get more precise location
        function getPreciseLocation() {
            if (navigator.geolocation) {
                try {
                    // Show loading message
                    const loadingMessage = document.createElement('div');
                    loadingMessage.className = 'alert alert-info mt-2';
                    loadingMessage.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Searching for more precise location...</span>
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    `;
                    document.getElementById('map').parentElement.appendChild(loadingMessage);

                    // Remove any existing accuracy messages
                    const accuracyMessage = document.querySelector('.alert-warning');
                    if (accuracyMessage) {
                        accuracyMessage.remove();
                    }

                    // Start watching position
                    const watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            // Update map with high zoom level for precision
                            map.setCenter(pos);
                            map.setZoom(18);

                            // Update marker with precise position
                            if (marker) {
                                marker.position = pos;
                            }

                            // Get address details
                            geocoder.geocode({ 
                                location: pos
                            }, (results, status) => {
                                if (status === 'OK' && results[0]) {
                                    updateAddressFields(results[0]);
                                    // Update search input with formatted address
                                    document.getElementById('locationSearch').value = results[0].formatted_address;
                                }
                            });

                            // Check if accuracy is good enough (less than 50 meters)
                            if (position.coords.accuracy <= 50) {
                                // Stop watching position
                                navigator.geolocation.clearWatch(watchId);
                                
                                // Remove loading message
                                loadingMessage.remove();
                                
                                // Show success message
                                const successMessage = document.createElement('div');
                                successMessage.className = 'alert alert-success mt-2';
                                successMessage.innerHTML = `
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>Location found with high accuracy (${Math.round(position.coords.accuracy)}m)</span>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                                    </div>
                                `;
                                document.getElementById('map').parentElement.appendChild(successMessage);
                            } else {
                                // Update loading message with current accuracy
                                loadingMessage.querySelector('span').textContent = 
                                    `Searching for precise location... Current accuracy: ${Math.round(position.coords.accuracy)}m`;
                            }
                        },
                        (error) => {
                            // Stop watching position
                            navigator.geolocation.clearWatch(watchId);
                            
                            // Remove loading message
                            loadingMessage.remove();
                            
                            console.error('Error getting precise location:', error);
                            alert('Error getting precise location. Please try again or adjust the marker manually.');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 30000,
                            maximumAge: 0
                        }
                    );
                } catch (error) {
                    console.error('Error in getPreciseLocation:', error);
                }
            }
        }

        // Update address fields from place
        function updateAddressFields(place) {
            let streetNumber = '';
            let route = '';
            let city = '';
            let administrativeArea = '';

            // Extract address components
            place.address_components.forEach(component => {
                const type = component.types[0];
                if (type === 'street_number') streetNumber = component.long_name;
                if (type === 'route') route = component.long_name;
                if (type === 'locality') city = component.long_name;
                if (type === 'administrative_area_level_1') administrativeArea = component.long_name;
            });

            // Update street address
            document.getElementById('streetAddress').value = `${streetNumber} ${route}`.trim();

            // Update city (use administrative area if city is not available)
            document.getElementById('city').value = city || administrativeArea;
        }

        // Reset map
        document.getElementById('resetMap').addEventListener('click', () => {
            const defaultCenter = { lat: -6.369028, lng: 34.888822 };
            map.setCenter(defaultCenter);
            map.setZoom(6);
            
            // Reset marker using the new position property
            marker.position = defaultCenter;
            
            document.getElementById('locationSearch').value = '';
            document.getElementById('streetAddress').value = '';
            document.getElementById('city').value = '';
        });

        // Use current location
        document.getElementById('useMyLocation').addEventListener('click', () => {
            if (!map || !marker || !geocoder) {
                alert('Map is not ready yet. Please wait a moment and try again.');
                return;
            }

            if (navigator.geolocation) {
                // Show loading message
                const loadingMessage = document.createElement('div');
                loadingMessage.className = 'alert alert-info mt-2';
                loadingMessage.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Searching for precise location...</span>
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
                document.getElementById('map').parentElement.appendChild(loadingMessage);

                // Get current position with high accuracy
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Log location details for debugging
                        console.log('Latitude:', position.coords.latitude);
                        console.log('Longitude:', position.coords.longitude);
                        console.log('Accuracy:', position.coords.accuracy, 'meters');
                        console.log('Altitude:', position.coords.altitude);
                        console.log('Altitude Accuracy:', position.coords.altitudeAccuracy);
                        console.log('Heading:', position.coords.heading);
                        console.log('Speed:', position.coords.speed);

                        // Update map with high zoom level for precision
                        map.setCenter(pos);
                        map.setZoom(18);

                        // Update marker with precise position
                        if (marker) {
                            marker.position = pos;
                        }

                        // Get address details
                        geocoder.geocode({ 
                            location: pos
                        }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                updateAddressFields(results[0]);
                                // Update search input with formatted address
                                document.getElementById('locationSearch').value = results[0].formatted_address;
                            }
                        });

                        // Remove loading message
                        loadingMessage.remove();
                        
                        // Show accuracy message with detailed information
                        const accuracyMessage = document.createElement('div');
                        accuracyMessage.className = 'alert alert-success mt-2';
                        accuracyMessage.innerHTML = `
                            <div class="d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Location found with accuracy: ${Math.round(position.coords.accuracy)}m</span>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                                </div>
                                <small class="text-muted">
                                    If accuracy is low, try:
                                    <ul class="mb-0">
                                        <li>Enabling precise location in your phone settings</li>
                                        <li>Opening Google Maps first to calibrate GPS</li>
                                        <li>Moving to an open area with clear sky view</li>
                                    </ul>
                                </small>
                            </div>
                        `;
                        document.getElementById('map').parentElement.appendChild(accuracyMessage);
                    },
                    (error) => {
                        // Remove loading message
                        loadingMessage.remove();
                        
                        console.error('Error getting location:', error);
                        
                        // Show detailed error message with troubleshooting tips
                        const errorMessage = document.createElement('div');
                        errorMessage.className = 'alert alert-danger mt-2';
                        errorMessage.innerHTML = `
                            <div class="d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Error getting your location</span>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                                </div>
                                <small class="text-muted">
                                    Troubleshooting tips:
                                    <ul class="mb-0">
                                        <li>Enable location services in your browser settings</li>
                                        <li>Enable precise location in your phone settings</li>
                                        <li>Try opening Google Maps first to calibrate GPS</li>
                                        <li>Move to an open area with clear sky view</li>
                                        <li>Or search for a location manually</li>
                                    </ul>
                                </small>
                            </div>
                        `;
                        document.getElementById('map').parentElement.appendChild(errorMessage);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 20000,
                        maximumAge: 0
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser.');
            }
        });

        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                if (!data.isAuthenticated) {
                    window.location.href = '/login.html';
                }
            } catch (error) {
                window.location.href = '/login.html';
            }
        }

        // Load shops
        async function loadShops() {
            try {
                const response = await fetch('/api/shops');
                const shops = await response.json();
                
                const shopsHtml = shops.map(shop => `
                    <tr class="fade-in">
                        <td>${shop.name}</td>
                        <td>${shop.address}</td>
                        <td>${shop.city}</td>
                        <td>${shop.contactNumber}</td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="editShop('${shop._id}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteShop('${shop._id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                document.getElementById('shops-table').innerHTML = shopsHtml;
            } catch (error) {
                console.error('Error loading shops:', error);
            }
        }

        // Edit shop
        async function editShop(id) {
            try {
                const response = await fetch(`/api/shops/${id}`);
                const shop = await response.json();
                
                document.getElementById('modalTitle').textContent = 'Edit Shop';
                document.getElementById('shopName').value = shop.name;
                document.getElementById('streetAddress').value = shop.address;
                document.getElementById('city').value = shop.city;
                document.getElementById('contactNumber').value = shop.contactNumber;
                
                // Geocode the address and update map
                geocoder.geocode({ address: `${shop.address}, ${shop.city}` }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        map.setCenter(location);
                        map.setZoom(15);
                        marker.position = location;
                    }
                });
                
                currentShopId = id;
                shopModal.show();
            } catch (error) {
                console.error('Error loading shop:', error);
            }
        }

        // Delete shop
        async function deleteShop(id) {
            if (confirm('Are you sure you want to delete this shop?')) {
                try {
                    await fetch(`/api/shops/${id}`, { method: 'DELETE' });
                    loadShops();
                } catch (error) {
                    console.error('Error deleting shop:', error);
                }
            }
        }

        // Save shop
        document.getElementById('saveShopBtn').addEventListener('click', async () => {
            const spinner = document.querySelector('.spinner-border');
            const errorAlert = document.getElementById('errorAlert');
            
            // Validate form
            const form = document.getElementById('shopForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            try {
                spinner.classList.remove('d-none');
                errorAlert.classList.add('d-none');

                // Get form data
                const name = document.getElementById('shopName').value.trim();
                const address = document.getElementById('streetAddress').value.trim();
                const city = document.getElementById('city').value.trim();
                const contactNumber = document.getElementById('contactNumber').value.trim();

                // Validate required fields
                if (!name) throw new Error('Shop name is required');
                if (!address) throw new Error('Street address is required');
                if (!city) throw new Error('City is required');
                if (!contactNumber) throw new Error('Contact number is required');

                // Get marker position using the new property
                const position = marker.position;
                if (!position) throw new Error('Please select a location on the map');
                
                // Prepare shop data
                const shopData = {
                    name,
                    address,
                    city,
                    contactNumber,
                    location: {
                        lat: position.lat,
                        lng: position.lng
                    }
                };

                const url = currentShopId ? `/api/shops/${currentShopId}` : '/api/shops';
                const method = currentShopId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(shopData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || data.error || 'Failed to save shop');
                }

                // Show success message
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show';
                successAlert.innerHTML = `
                    <strong>Success!</strong> Shop has been ${currentShopId ? 'updated' : 'created'} successfully.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Insert the alert before the card
                const card = document.querySelector('.card');
                const container = card.parentElement;
                container.insertBefore(successAlert, card);

                shopModal.hide();
                loadShops();
                resetForm();

                // Remove success message after 3 seconds
                setTimeout(() => {
                    successAlert.remove();
                }, 3000);
            } catch (error) {
                console.error('Error saving shop:', error);
                console.error('Error details:', error.message);
                errorAlert.textContent = error.message || 'An error occurred while saving the shop';
                errorAlert.classList.remove('d-none');
            } finally {
                spinner.classList.add('d-none');
            }
        });

        // Reset form
        function resetForm() {
            const form = document.getElementById('shopForm');
            form.reset();
            form.classList.remove('was-validated');
            document.getElementById('modalTitle').textContent = 'Add New Shop';
            document.getElementById('errorAlert').classList.add('d-none');
            document.getElementById('locationSearch').value = '';
            document.getElementById('streetAddress').value = '';
            document.getElementById('city').value = '';
            currentShopId = null;
            
            // Reset map
            const defaultCenter = { lat: -6.369028, lng: 34.888822 };
            map.setCenter(defaultCenter);
            map.setZoom(6);
            
            // Reset marker using the new position property
            marker.position = defaultCenter;
        }

        // Handle modal show/hide events
        document.getElementById('shopModal').addEventListener('show.bs.modal', () => {
            try {
                // Show loading indicator
                const spinner = document.createElement('div');
                spinner.className = 'position-absolute top-50 start-50 translate-middle';
                spinner.innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2 text-center">Loading map...</div>
                `;
                document.getElementById('map').appendChild(spinner);
            } catch (error) {
                console.error('Error in modal show event:', error);
            }
        });

        document.getElementById('shopModal').addEventListener('shown.bs.modal', () => {
            // Remove aria-hidden after modal is shown
            document.getElementById('shopModal').removeAttribute('aria-hidden');
        });

        document.getElementById('shopModal').addEventListener('hide.bs.modal', () => {
            // Set aria-hidden before modal is hidden
            document.getElementById('shopModal').setAttribute('aria-hidden', 'true');
        });

        // Handle modal close button
        document.querySelector('#shopModal .btn-close').addEventListener('click', () => {
            const modal = document.getElementById('shopModal');
            modal.setAttribute('aria-hidden', 'true');
            modal.classList.remove('show');
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
            const modalBackdrop = document.querySelector('.modal-backdrop');
            if (modalBackdrop) {
                modalBackdrop.remove();
            }
        });

        // Form validation
        document.getElementById('shopForm').addEventListener('submit', function(e) {
            e.preventDefault();
            this.classList.add('was-validated');
        });

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await fetch('/api/auth/logout');
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Error logging out:', error);
            }
        });

        // Initialize
        checkAuth();
        loadShops();
    </script>
</body>
</html> 