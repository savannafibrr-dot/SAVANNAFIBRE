<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coverage Areas - Savanna Fibre</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .navbar {
            background: #3C1800;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #4a1e00;
        }
        .navbar-brand {
            padding: 0.5rem 0;
        }
        .navbar-brand img {
            height: 40px;
            width: auto;
        }
        .navbar-toggler {
            border: 1px solid #ff6600;
            padding: 0.5rem;
            background-color: transparent;
        }
        .navbar-toggler:focus {
            box-shadow: 0 0 0 0.25rem rgba(255, 102, 0, 0.25);
        }
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(255, 255, 255, 0.75)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        .nav-link {
            padding: 0.75rem 1rem;
            color: #ffffff !important;
            font-weight: 500;
            display: flex;
            align-items: center;
            border-radius: 6px;
            transition: all 0.2s ease;
            opacity: 0.85;
            margin: 0.25rem 0;
        }
        .nav-link:hover {
            color: #ffffff !important;
            background: rgba(255, 255, 255, 0.15);
            opacity: 1;
        }
        .nav-link.active {
            color: #ffffff !important;
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
            opacity: 1;
        }
        .nav-link i {
            margin-right: 0.75rem;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }
        @media (max-width: 991.98px) {
            .navbar-collapse {
                background: #3C1800;
                padding: 1rem;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                margin-top: 1rem;
                border: 1px solid #4a1e00;
            }
            .navbar-nav {
                gap: 0.25rem;
            }
            .nav-link {
                padding: 0.75rem 1rem;
                margin: 0.25rem 0;
            }
        }
        @media (min-width: 992px) {
            .navbar {
                padding: 1rem;
            }
            .navbar-nav {
                gap: 0.5rem;
            }
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .coordinates-display {
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 14px;
            z-index: 1;
        }
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
            display: flex;
            gap: 8px;
        }
        .map-controls button {
            background: white;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .map-controls button:hover {
            background: #f8f9fa;
        }
        .path-info {
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 14px;
            z-index: 1;
        }
        .coverage-list {
            margin-bottom: 2rem;
        }
        .coverage-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }
        .coverage-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .coverage-card .card-body {
            padding: 1.25rem;
        }
        .coverage-map {
            height: 200px;
            border-radius: 8px 8px 0 0;
        }
        .coverage-details {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        .coverage-detail {
            font-size: 0.875rem;
            color: #6c757d;
        }
        .add-coverage-section {
            display: none;
        }
        .add-coverage-section.show {
            display: block;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <img src="/images/logo.png" alt="Savanna Fibre" height="40">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard">
                            <i class="bi bi-speedometer2"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/plans">
                            <i class="bi bi-wifi"></i>
                            Internet Plans
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/shop">
                            <i class="bi bi-shop"></i>
                            Shop Locations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/coverages">
                            <i class="bi bi-broadcast-pin"></i>
                            Coverage Areas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/banners">
                            <i class="bi bi-images"></i>
                            Banner Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/faq-admin.html">
                            <i class="bi bi-question-circle"></i>
                            FAQ Admin
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/payments-admin.html">
                            <i class="fa fa-money-bill"></i>
                            Payments Admin
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logout-btn">
                            <i class="bi bi-box-arrow-right"></i>
                            Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">Coverage Areas</h1>
                <p class="text-secondary mb-0">Network coverage regions and paths</p>
            </div>
            <button class="btn btn-primary" id="showAddFormBtn">
                <i class="bi bi-plus-lg me-2"></i>
                Add New Coverage
            </button>
        </div>

        <!-- Coverage List Section -->
        <div id="coverageList" class="coverage-list">
            <div class="row" id="coverageGrid">
                <!-- Coverage cards will be inserted here -->
            </div>
        </div>

        <!-- Add Coverage Form Section -->
        <div id="addCoverageSection" class="add-coverage-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="h4 mb-0">Add New Coverage Area</h2>
                <button class="btn btn-outline-secondary" id="hideAddFormBtn">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="row">
                <div class="col-md-5">
                    <div class="form-section">
                        <form id="coverageForm" class="needs-validation" novalidate>
                            <div class="mb-3">
                                <label class="form-label">City Name</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-geo-alt"></i>
                                    </span>
                                    <input type="text" class="form-control" id="regionName" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Subregion Name</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-geo"></i>
                                    </span>
                                    <input type="text" class="form-control" id="subregionName" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-card-text"></i>
                                    </span>
                                    <textarea class="form-control" id="description" rows="3" required></textarea>
                                </div>
                            </div>

                            <!-- Hidden inputs for coordinates and path -->
                            <input type="hidden" id="centerLat" name="centerLat">
                            <input type="hidden" id="centerLng" name="centerLng">
                            <input type="hidden" id="pathCoordinates" name="pathCoordinates">

                            <div class="alert alert-danger d-none" id="errorAlert"></div>
                            <div class="alert alert-info d-none" id="infoAlert">
                                Click points on the map to draw the coverage path
                            </div>

                            <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                                <span class="spinner-border spinner-border-sm d-none me-2"></span>
                                Save Coverage Area
                            </button>
                        </form>
                    </div>
                </div>

                <div class="col-md-7">
                    <div class="card h-100">
                        <div class="card-body p-0">
                            <div class="position-relative">
                                <div id="map"></div>
                                <div class="map-controls">
                                    <button type="button" id="clearPathBtn">
                                        <i class="bi bi-trash"></i>
                                        Clear Path
                                    </button>
                                </div>
                                <div class="path-info d-none" id="pathInfo">
                                    <i class="bi bi-geo-alt me-2"></i>
                                    <span id="pointCount">0 points</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let map;
        let geocoder;
        let polyline;
        let markers = [];
        let path = [];

        // Load Google Maps API with required libraries
        function loadGoogleMapsAPI() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBV7cqwH-DW9ICtLYjnhV3v_1teQyotZzA&libraries=places,geometry&callback=initMap';
                script.async = true;
                script.defer = true;
                script.onerror = reject;
                script.onload = resolve;
                document.head.appendChild(script);
            });
        }

        // Initialize map
        async function initMap() {
            try {
                // Default center (Tanzania)
                const defaultCenter = { lat: -6.369028, lng: 34.888822 };
                
                // Initialize map
                map = new google.maps.Map(document.getElementById('map'), {
                    center: defaultCenter,
                    zoom: 6,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false
                });

                // Initialize geocoder
                geocoder = new google.maps.Geocoder();

                // Initialize polyline for path drawing
                polyline = new google.maps.Polyline({
                    map: map,
                    path: [],
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 3
                });

                // Show info alert
                document.getElementById('infoAlert').classList.remove('d-none');

                // Add click listener to map
                map.addListener('click', (event) => {
                    const position = event.latLng;
                    
                    // Add marker
                    const marker = new google.maps.Marker({
                        position: position,
                        map: map,
                        icon: markers.length === 0 ? {
                            url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                        } : undefined
                    });
                    markers.push(marker);

                    // Update path
                    path.push({ lat: position.lat(), lng: position.lng() });
                    polyline.setPath(path);

                    // Update hidden inputs
                    if (markers.length === 1) {
                        document.getElementById('centerLat').value = position.lat();
                        document.getElementById('centerLng').value = position.lng();
                    }
                    document.getElementById('pathCoordinates').value = JSON.stringify(path);

                    // Update path info
                    updatePathInfo();
                });

                // Add input listeners for geocoding
                setupGeocoding();

            } catch (error) {
                console.error('Error initializing map:', error);
                showError('Error loading map. Please check your internet connection and try again.');
            }
        }

        // Setup geocoding for region and subregion inputs
        function setupGeocoding() {
            const regionInput = document.getElementById('regionName');
            const subregionInput = document.getElementById('subregionName');

            regionInput.addEventListener('blur', () => geocodeLocation(regionInput.value, 8));
            subregionInput.addEventListener('blur', () => {
                const fullLocation = `${regionInput.value}, ${subregionInput.value}`;
                geocodeLocation(fullLocation, 12);
            });
        }

        // Geocode location and zoom map
        function geocodeLocation(address, zoomLevel) {
            if (!address) return;

            geocoder.geocode({ address: address + ', Tanzania' }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;
                    map.setCenter(location);
                    map.setZoom(zoomLevel);
                }
            });
        }

        // Update path info display
        function updatePathInfo() {
            const pathInfo = document.getElementById('pathInfo');
            const pointCount = document.getElementById('pointCount');
            
            pathInfo.classList.remove('d-none');
            pointCount.textContent = `${markers.length} point${markers.length === 1 ? '' : 's'}`;
        }

        // Clear path
        document.getElementById('clearPathBtn').addEventListener('click', () => {
            // Clear markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // Clear path
            path = [];
            polyline.setPath([]);

            // Clear hidden inputs
            document.getElementById('centerLat').value = '';
            document.getElementById('centerLng').value = '';
            document.getElementById('pathCoordinates').value = '';

            // Hide path info
            document.getElementById('pathInfo').classList.add('d-none');
        });

        // Form submission handler
        document.getElementById('coverageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const spinner = document.querySelector('.spinner-border');
            const errorAlert = document.getElementById('errorAlert');
            const submitBtn = document.getElementById('submitBtn');
            
            try {
                // Validate path
                if (path.length < 2) {
                    throw new Error('Please draw a path with at least 2 points on the map');
                }

                // Show loading state
                spinner.classList.remove('d-none');
                submitBtn.disabled = true;
                errorAlert.classList.add('d-none');

                // Get form data
                const formData = {
                    region: document.getElementById('regionName').value.trim(),
                    subregion: document.getElementById('subregionName').value.trim(),
                    description: document.getElementById('description').value.trim(),
                    centerCoordinates: {
                        lat: parseFloat(document.getElementById('centerLat').value),
                        lng: parseFloat(document.getElementById('centerLng').value)
                    },
                    path: path
                };

                // Send data to server
                const response = await fetch('/api/coverage/add-coverage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to add coverage area');
                }

                // Show success message
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show';
                successAlert.innerHTML = `
                    <strong>Success!</strong> Coverage area has been added successfully.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.form-section').insertBefore(successAlert, document.getElementById('coverageForm'));

                // Reset form and map
                e.target.reset();
                document.getElementById('clearPathBtn').click();

                // Remove success message after 3 seconds
                setTimeout(() => successAlert.remove(), 3000);

            } catch (error) {
                console.error('Error saving coverage area:', error);
                errorAlert.textContent = error.message;
                errorAlert.classList.remove('d-none');
            } finally {
                spinner.classList.add('d-none');
                submitBtn.disabled = false;
            }
        });

        // Toggle form visibility
        document.getElementById('showAddFormBtn').addEventListener('click', () => {
            document.getElementById('coverageList').style.display = 'none';
            document.getElementById('addCoverageSection').classList.add('show');
        });

        document.getElementById('hideAddFormBtn').addEventListener('click', () => {
            document.getElementById('coverageList').style.display = 'block';
            document.getElementById('addCoverageSection').classList.remove('show');
            // Reset form and map
            document.getElementById('coverageForm').reset();
            document.getElementById('clearPathBtn').click();
        });

        // Load and display coverage areas
        async function loadCoverageAreas() {
            try {
                const response = await fetch('/api/coverage');
                if (!response.ok) {
                    throw new Error('Failed to fetch coverage areas');
                }

                const coverageAreas = await response.json();
                const grid = document.getElementById('coverageGrid');
                
                if (coverageAreas.length === 0) {
                    grid.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info">
                                No coverage areas defined yet. Click "Add New Coverage" to create one.
                            </div>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = coverageAreas.map(coverage => `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="coverage-card">
                            <div class="coverage-map" id="map-${coverage._id}"></div>
                            <div class="card-body">
                                <h5 class="card-title">${coverage.region}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">${coverage.subregion}</h6>
                                <p class="card-text small">${coverage.description}</p>
                                <div class="coverage-details">
                                    <span class="coverage-detail">
                                        <i class="bi bi-geo-alt me-1"></i>
                                        ${coverage.path.length} points
                                    </span>
                                    <span class="coverage-detail">
                                        <i class="bi bi-calendar me-1"></i>
                                        ${new Date(coverage.createdAt).toLocaleDateString()}
                                    </span>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="editCoverage('${coverage._id}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCoverage('${coverage._id}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Initialize mini maps for each coverage area
                coverageAreas.forEach(coverage => {
                    const mapElement = document.getElementById(`map-${coverage._id}`);
                    const miniMap = new google.maps.Map(mapElement, {
                        center: coverage.centerCoordinates,
                        zoom: 12,
                        disableDefaultUI: true,
                        gestureHandling: 'none'
                    });

                    // Draw path
                    new google.maps.Polyline({
                        map: miniMap,
                        path: coverage.path,
                        strokeColor: '#FF0000',
                        strokeOpacity: 1.0,
                        strokeWeight: 2
                    });

                    // Add markers
                    new google.maps.Marker({
                        position: coverage.path[0],
                        map: miniMap,
                        icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                    });

                    coverage.path.slice(1).forEach(point => {
                        new google.maps.Marker({
                            position: point,
                            map: miniMap
                        });
                    });
                });

            } catch (error) {
                console.error('Error loading coverage areas:', error);
                document.getElementById('coverageGrid').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            Error loading coverage areas. Please try again later.
                        </div>
                    </div>
                `;
            }
        }

        // Edit coverage area
        async function editCoverage(id) {
            try {
                const response = await fetch(`/api/coverage/${id}`);
                if (!response.ok) throw new Error('Failed to fetch coverage area');
                
                const coverage = await response.json();
                
                // Show form section
                document.getElementById('showAddFormBtn').click();
                
                // Fill form fields
                document.getElementById('regionName').value = coverage.region;
                document.getElementById('subregionName').value = coverage.subregion;
                document.getElementById('description').value = coverage.description;
                
                // Set center coordinates
                document.getElementById('centerLat').value = coverage.centerCoordinates.lat;
                document.getElementById('centerLng').value = coverage.centerCoordinates.lng;
                
                // Set path
                path = coverage.path;
                document.getElementById('pathCoordinates').value = JSON.stringify(path);
                
                // Update map
                map.setCenter(coverage.centerCoordinates);
                map.setZoom(12);
                
                // Clear existing markers and path
                markers.forEach(marker => marker.setMap(null));
                markers = [];
                
                // Add markers and update path
                coverage.path.forEach((point, index) => {
                    const marker = new google.maps.Marker({
                        position: point,
                        map: map,
                        icon: index === 0 ? {
                            url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                        } : undefined
                    });
                    markers.push(marker);
                });
                
                polyline.setPath(path);
                updatePathInfo();
                
            } catch (error) {
                console.error('Error editing coverage area:', error);
                alert('Error loading coverage area for editing');
            }
        }

        // Delete coverage area
        async function deleteCoverage(id) {
            if (!confirm('Are you sure you want to delete this coverage area?')) return;
            
            try {
                const response = await fetch(`/api/coverage/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete coverage area');
                
                // Reload coverage areas
                loadCoverageAreas();
                
            } catch (error) {
                console.error('Error deleting coverage area:', error);
                alert('Error deleting coverage area');
            }
        }

        // Initialize everything after DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadGoogleMapsAPI();
                await checkAuth();
                await loadCoverageAreas();
            } catch (error) {
                console.error('Error during initialization:', error);
            }
        });

        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                if (!data.isAuthenticated) {
                    window.location.href = '/login.html';
                }
            } catch (error) {
                window.location.href = '/login.html';
            }
        }

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await fetch('/api/auth/logout');
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Error logging out:', error);
            }
        });
    </script>
</body>
</html> 