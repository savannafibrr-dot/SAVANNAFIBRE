<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Locations - Savanna Fibre</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .navbar {
            background: #3C1800;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #4a1e00;
        }
        .navbar-brand {
            padding: 0.5rem 0;
        }
        .navbar-brand img {
            height: 40px;
            width: auto;
        }
        .navbar-toggler {
            border: 1px solid #ff6600;
            padding: 0.5rem;
            background-color: transparent;
        }
        .navbar-toggler:focus {
            box-shadow: 0 0 0 0.25rem rgba(255, 102, 0, 0.25);
        }
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(255, 255, 255, 0.75)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        .nav-link {
            padding: 0.75rem 1rem;
            color: #ffffff !important;
            font-weight: 500;
            display: flex;
            align-items: center;
            border-radius: 6px;
            transition: all 0.2s ease;
            opacity: 0.85;
            margin: 0.25rem 0;
        }
        .nav-link:hover {
            color: #ffffff !important;
            background: rgba(255, 255, 255, 0.15);
            opacity: 1;
        }
        .nav-link.active {
            color: #ffffff !important;
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
            opacity: 1;
        }
        .nav-link i {
            margin-right: 0.75rem;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }
        @media (max-width: 991.98px) {
            .navbar-collapse {
                background: #3C1800;
                padding: 1rem;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                margin-top: 1rem;
                border: 1px solid #4a1e00;
            }
            .navbar-nav {
                gap: 0.25rem;
            }
            .nav-link {
                padding: 0.75rem 1rem;
                margin: 0.25rem 0;
            }
        }
        @media (min-width: 992px) {
            .navbar {
                padding: 1rem;
            }
            .navbar-nav {
                gap: 0.5rem;
            }
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .location-search {
            position: relative;
            margin-bottom: 1rem;
        }
        .location-search input {
            padding-right: 40px;
        }
        .location-search .btn {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            border-radius: 0 8px 8px 0;
        }
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
        }
        .map-controls .btn {
            margin-bottom: 5px;
            background: white;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .map-controls .btn:hover {
            background: #f8f9fa;
        }
        .address-details {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .address-details .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .address-details .form-control {
            background: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <img src="/images/logo.png" alt="Savanna Fibre" height="40">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard">
                            <i class="bi bi-speedometer2"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/plans">
                            <i class="bi bi-wifi"></i>
                            Internet Plans
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/shop">
                            <i class="bi bi-shop"></i>
                            Shop Locations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/coverage">
                            <i class="bi bi-broadcast-pin"></i>
                            Coverage Areas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/banners">
                            <i class="bi bi-images"></i>
                            Banner Management
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logout-btn">
                            <i class="bi bi-box-arrow-right"></i>
                            Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div>
                <h1 class="h3 mb-1">Shop Locations</h1>
                <p class="text-secondary mb-0">Manage your shop locations</p>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#shopModal">
                <i class="bi bi-plus-lg me-2"></i>
                Add New Shop
            </button>
        </div>

        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th>SHOP IMAGE</th>
                                <th>SHOP NAME</th>
                                <th>ADDRESS</th>
                                <th>CITY</th>
                                <th>CONTACT</th>
                                <th>OPENING HOURS</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="shops-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Shop Modal -->
    <div class="modal fade" id="shopModal" tabindex="-1" role="dialog" aria-labelledby="modalTitle">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add New Shop</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger d-none" id="errorAlert"></div>
                    <div class="row">
                        <div class="col-md-6">
                            <form id="shopForm" novalidate>
                                <div class="mb-3">
                                    <label class="form-label">Shop Name</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-shop"></i>
                                        </span>
                                        <input type="text" class="form-control" id="shopName" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Street Address</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-geo-alt"></i>
                                        </span>
                                        <input type="text" class="form-control" id="streetAddress" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">City</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-building"></i>
                                        </span>
                                        <input type="text" class="form-control" id="city" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Contact Number</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-telephone"></i>
                                        </span>
                                        <input type="tel" class="form-control" id="contactNumber" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Opening Hours <strong>(Mon-Fri)</strong></label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="input-group mb-2">
                                                <span class="input-group-text">Open</span>
                                                <input type="time" class="form-control" id="openTime" value="09:00">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="input-group mb-2">
                                                <span class="input-group-text">Close</span>
                                                <input type="time" class="form-control" id="closeTime" value="17:00">
                                            </div>
                                        </div>
                                    </div>
                                    <small class="text-muted">Monday to Friday hours</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Weekend Hours (Saturday & Sunday)</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="input-group mb-2">
                                                <span class="input-group-text">Open</span>
                                                <input type="time" class="form-control" id="weekendOpenTime" value="09:00">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="input-group mb-2">
                                                <span class="input-group-text">Close</span>
                                                <input type="time" class="form-control" id="weekendCloseTime" value="17:00">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Shop Image</label>
                                    <div class="input-group">
                                        <input type="file" class="form-control" id="shopImage" accept="image/*">
                                    </div>
                                    <small class="text-muted">Upload a picture of your shop (optional) <strong>(PNG only, 1920x1000)</strong></small>
                                    <div id="imagePreview" class="mt-2 d-none">
                                        <img src="" alt="Shop Preview" class="img-thumbnail" style="max-height: 200px;">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body p-0">
                                    <div class="position-relative">
                                        <div id="map" style="height: 400px; border-radius: 4px;"></div>
                                        <div id="mapControls" class="position-absolute top-0 end-0 m-2">
                                            <div class="btn-group-vertical shadow">
                                                <button class="btn btn-light btn-sm" onclick="getCurrentLocation()" title="Get Current Location">
                                                    <i class="bi bi-geo-fill text-primary"></i>
                                                </button>
                                                <button class="btn btn-light btn-sm" onclick="openGoogleMaps()" title="Open in Google Maps">
                                                    <i class="bi bi-map text-success"></i>
                                                </button>
                                                <button class="btn btn-light btn-sm" data-bs-toggle="collapse" data-bs-target="#searchBox" title="Search Location">
                                                    <i class="bi bi-search text-primary"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div id="searchBox" class="collapse position-absolute top-0 start-0 m-2 w-75">
                                            <div class="input-group shadow">
                                                <input type="text" class="form-control" id="locationSearch" placeholder="Search location...">
                                                <button class="btn btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#searchBox">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div id="accuracyInfo" class="position-absolute bottom-0 start-0 m-2 d-none">
                                            <div class="bg-white p-2 rounded shadow-sm">
                                                <small class="d-flex align-items-center">
                                                    <i class="bi bi-geo-alt me-2"></i>
                                                    Accuracy: <span id="currentAccuracy" class="ms-1 fw-bold">...</span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveShopBtn">
                        <span class="spinner-border spinner-border-sm d-none me-2"></span>
                        Save Shop
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Maps API -->
    <script>
        // Load Google Maps API with the correct API key and wait for it to load
        function loadGoogleMapsAPI() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBV7cqwH-DW9ICtLYjnhV3v_1teQyotZzA&libraries=places,marker&loading=async&callback=initMap';
                script.async = true;
                script.defer = true;
                script.onerror = reject;
                script.onload = resolve;
                document.head.appendChild(script);
            });
        }

        // Initialize everything after DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadGoogleMapsAPI();
                // Rest of initialization will happen in initMap callback
            } catch (error) {
                console.error('Error loading Google Maps:', error);
                alert('Error loading Google Maps. Please check your internet connection and try again.');
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentShopId = null;
        let map;
        let marker;
        let geocoder;
        let autocomplete;
        const shopModal = new bootstrap.Modal(document.getElementById('shopModal'));

        // Initialize Google Maps
        async function initMap() {
            try {
                // Default center (Tanzania)
                const defaultCenter = { lat: -6.369028, lng: 34.888822 };
                
                // Initialize map
                map = new google.maps.Map(document.getElementById('map'), {
                    center: defaultCenter,
                    zoom: 6,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false
                });

                // Initialize geocoder
                geocoder = new google.maps.Geocoder();

                // Initialize Places Autocomplete
                const input = document.getElementById('locationSearch');
                autocomplete = new google.maps.places.Autocomplete(input, {
                    componentRestrictions: { country: 'tz' },
                    fields: ['address_components', 'geometry', 'name', 'formatted_address'],
                    types: ['address']
                });

                // Initialize marker
                marker = new google.maps.Marker({
                    map,
                    position: defaultCenter,
                    draggable: true
                });

                // Set up event listeners for Places Autocomplete
                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (!place.geometry) {
                        console.log('No location found for input:', input.value);
                        return;
                    }

                    // Update map
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                    marker.setPosition(place.geometry.location);
                    updateAddressFields(place);
                });

                // Set up marker drag event
                marker.addListener('dragend', () => {
                    const position = marker.getPosition();
                    geocoder.geocode({ location: position }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            updateAddressFields(results[0]);
                        }
                    });
                });

                // Set up map click event
                map.addListener('click', (event) => {
                    marker.setPosition(event.latLng);
                    geocoder.geocode({ location: event.latLng }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            updateAddressFields(results[0]);
                        }
                    });
                });

                // Request location permission
                await requestLocationPermission();

                // Load initial data
                await checkAuth();
                await loadShops();

            } catch (error) {
                console.error('Error initializing map:', error);
                const errorMessage = document.createElement('div');
                errorMessage.className = 'alert alert-danger mt-2';
                errorMessage.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <div>
                            <strong>Error loading map:</strong> ${error.message}
                            <div class="small mt-1">
                                Please check:
                                <ul class="mb-0">
                                    <li>Your internet connection</li>
                                    <li>That the Places API is enabled in Google Cloud Console</li>
                                    <li>Your API key has the correct permissions</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('map').parentElement.appendChild(errorMessage);
            }
        }

        // Handle form submit
        function handleFormSubmit(e) {
            e.preventDefault();
            e.stopPropagation();
            const form = e.target;
            form.classList.add('was-validated');
        }

        // Get current location and update map
        async function getCurrentLocation() {
            // If user has chosen to use Google Maps, don't proceed with automatic location
            if (document.getElementById('usingGoogleMaps')) {
                return;
            }

            if (navigator.geolocation) {
                try {
                    // Show loading message with accuracy feedback
                    const loadingMessage = document.createElement('div');
                    loadingMessage.className = 'position-absolute top-50 start-50 translate-middle text-center bg-white p-3 rounded shadow';
                    loadingMessage.innerHTML = `
                        <div class="spinner-border text-primary mb-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>Getting your location...</div>
                        <small class="text-muted d-block">Current accuracy: <span id="loadingAccuracy">Calculating...</span></small>
                    `;
                    document.getElementById('map').appendChild(loadingMessage);

                    // Show accuracy info
                    document.getElementById('accuracyInfo').classList.remove('d-none');

                    // Get position once with high accuracy
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const accuracy = Math.round(position.coords.accuracy);
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            // Update map
                            map.setCenter(pos);
                            map.setZoom(18);
                            marker.setPosition(pos);

                            // Remove loading message
                            loadingMessage.remove();

                            // Get address details
                            geocoder.geocode({ location: pos }, (results, status) => {
                                if (status === 'OK' && results[0]) {
                                    updateAddressFields(results[0]);
                                }
                            });
                        },
                        (error) => {
                            console.error('Error getting location:', error);
                            loadingMessage.remove();
                            
                            const errorMessage = document.createElement('div');
                            errorMessage.className = 'alert alert-warning mt-2';
                            errorMessage.innerHTML = `
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <div>
                                        <div>Could not get your location</div>
                                        <small class="text-muted">Please use Google Maps to set your location</small>
                                    </div>
                                </div>
                            `;
                            document.getElementById('map').appendChild(errorMessage);
                            setTimeout(() => errorMessage.remove(), 3000);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                } catch (error) {
                    console.error('Error in getCurrentLocation:', error);
                }
            }
        }

        // Handle Google Maps opening
        function handleGoogleMapsOpen() {
            // Show search box if it's collapsed
            const searchBox = document.getElementById('searchBox');
            if (searchBox.classList.contains('collapse')) {
                new bootstrap.Collapse(searchBox).show();
            }

            // Update search box placeholder and focus
            const searchInput = document.getElementById('locationSearch');
            searchInput.placeholder = 'Paste Google Maps URL here...';
            searchInput.focus();

            // Add input event listener for URL handling
            searchInput.addEventListener('input', handleCoordinateInput);
        }

        // Handle coordinate input from Google Maps URL
        function handleCoordinateInput(e) {
            const input = e.target.value.trim();
            
            if (input.includes('google.com/maps')) {
                try {
                    // Extract coordinates from different URL formats
                    let lat, lng;
                    
                    // Try @lat,lng format
                    const atMatch = input.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
                    if (atMatch) {
                        lat = parseFloat(atMatch[1]);
                        lng = parseFloat(atMatch[2]);
                    }
                    
                    // Try !3d{lat}!4d{lng} format (alternative format)
                    if (!lat || !lng) {
                        const altMatch = input.match(/!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/);
                        if (altMatch) {
                            lat = parseFloat(altMatch[1]);
                            lng = parseFloat(altMatch[2]);
                        }
                    }

                    // Extract place name if available
                    const placeNameMatch = input.match(/place\/([^/@]+)/);
                    
                    if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                        const pos = { lat, lng };
                        console.log('Extracted coordinates:', pos); // Debug log
                        
                        // Update map
                        map.setCenter(pos);
                        map.setZoom(18);
                        marker.setPosition(pos);

                        // If place name is in URL, use it
                        if (placeNameMatch) {
                            const placeName = decodeURIComponent(placeNameMatch[1])
                                .replace(/\+/g, ' ')
                                .replace(/_/g, ' ');
                            document.getElementById('shopName').value = placeName;
                        }

                        // Get address details
                        geocoder.geocode({ location: pos }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                updateAddressFields(results[0]);
                                
                                // Show success message
                                const successMessage = document.createElement('div');
                                successMessage.className = 'alert alert-success alert-dismissible fade show mt-2';
                                successMessage.innerHTML = `
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-check-circle me-2"></i>
                                        Location set from Google Maps
                                    </div>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                `;
                                document.getElementById('map').parentElement.appendChild(successMessage);
                                setTimeout(() => successMessage.remove(), 3000);

                                // Clear the search input and collapse the search box
                                e.target.value = '';
                                const searchBox = document.getElementById('searchBox');
                                if (searchBox) {
                                    bootstrap.Collapse.getInstance(searchBox)?.hide();
                                }

                                // Add hidden input to indicate Google Maps is being used
                                let usingGoogleMaps = document.getElementById('usingGoogleMaps');
                                if (!usingGoogleMaps) {
                                    usingGoogleMaps = document.createElement('input');
                                    usingGoogleMaps.type = 'hidden';
                                    usingGoogleMaps.id = 'usingGoogleMaps';
                                    document.getElementById('shopForm').appendChild(usingGoogleMaps);
                                }

                                // Disable automatic location updates
                                if (autocomplete) {
                                    google.maps.event.clearListeners(autocomplete, 'place_changed');
                                }
                            }
                        });
                    } else {
                        console.log('No valid coordinates found in URL');
                    }
                } catch (error) {
                    console.error('Error parsing Google Maps URL:', error);
                }
            }
        }

        // Update the instructions in openGoogleMaps function
        function openGoogleMaps() {
            // Create and show instructions modal
            const instructionsModal = document.createElement('div');
            instructionsModal.className = 'modal fade';
            instructionsModal.id = 'googleMapsInstructions';
            instructionsModal.setAttribute('tabindex', '-1');
            instructionsModal.setAttribute('role', 'dialog');
            instructionsModal.setAttribute('aria-modal', 'true');
            instructionsModal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Set Shop Location using Google Maps</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <ol class="mb-4">
                                <li class="mb-2">Click "Open Google Maps" below</li>
                                <li class="mb-2">Search for your shop location</li>
                                <li class="mb-2">Click on your shop location to open its details</li>
                                <li class="mb-2">Copy the entire Google Maps URL from your browser</li>
                                <li class="mb-2">Return here and paste the URL in the search box</li>
                            </ol>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                The shop details will be automatically filled from Google Maps
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <a href="https://www.google.com/maps" target="_blank" 
                               class="btn btn-primary" 
                               onclick="handleGoogleMapsOpen()">
                                <i class="bi bi-map me-2"></i>
                                Open Google Maps
                            </a>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to body
            document.body.appendChild(instructionsModal);
            
            // Initialize and show the modal
            const modal = new bootstrap.Modal(instructionsModal);
            modal.show();
            
            // Remove modal from DOM after it's hidden
            instructionsModal.addEventListener('hidden.bs.modal', () => {
                instructionsModal.remove();
            });

            // Fix focus management
            instructionsModal.addEventListener('shown.bs.modal', () => {
                instructionsModal.removeAttribute('aria-hidden');
            });
        }

        // Request location permission
        async function requestLocationPermission() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }

            try {
                const permissionResult = await navigator.permissions.query({ name: 'geolocation' });
                
                if (permissionResult.state === 'granted') {
                    // Permission already granted
                    await getCurrentLocation();
                } else if (permissionResult.state === 'prompt') {
                    // Show custom permission request UI
                    const permissionDialog = document.createElement('div');
                    permissionDialog.className = 'alert alert-info mt-2';
                    permissionDialog.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span>This app needs your location to find nearby shops. Would you like to share your location?</span>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-primary" onclick="getCurrentLocation()">Allow</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Deny</button>
                            </div>
                        </div>
                    `;
                    document.getElementById('map').parentElement.appendChild(permissionDialog);
                } else {
                    // Permission denied
                    const deniedMessage = document.createElement('div');
                    deniedMessage.className = 'alert alert-warning mt-2';
                    deniedMessage.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Location access is denied. You can enable it in your browser settings or search for a location manually.</span>
                            <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                        </div>
                    `;
                    document.getElementById('map').parentElement.appendChild(deniedMessage);
                }
            } catch (error) {
                console.error('Error requesting location permission:', error);
                // Fallback to manual location selection
                const fallbackMessage = document.createElement('div');
                fallbackMessage.className = 'alert alert-info mt-2';
                fallbackMessage.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Please search for a location or click on the map to set the shop location.</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                    </div>
                `;
                document.getElementById('map').parentElement.appendChild(fallbackMessage);
            }
        }

        // Update address fields from place
        function updateAddressFields(place) {
            let streetNumber = '';
            let route = '';
            let city = '';
            let administrativeArea = '';

            // Extract address components
            place.address_components.forEach(component => {
                const type = component.types[0];
                if (type === 'street_number') streetNumber = component.long_name;
                if (type === 'route') route = component.long_name;
                if (type === 'locality') city = component.long_name;
                if (type === 'administrative_area_level_1') administrativeArea = component.long_name;
            });

            // Update street address
            document.getElementById('streetAddress').value = `${streetNumber} ${route}`.trim();

            // Update city (use administrative area if city is not available)
            document.getElementById('city').value = city || administrativeArea;
        }

        // Reset map
        function resetMap() {
            if (!map || !marker) return;
            
            const defaultCenter = { lat: -6.369028, lng: 34.888822 };
            map.setCenter(defaultCenter);
            map.setZoom(6);
            marker.setPosition(defaultCenter);
            
            const searchInput = document.getElementById('locationSearch');
            if (searchInput) searchInput.value = '';
            
            const streetAddress = document.getElementById('streetAddress');
            if (streetAddress) streetAddress.value = '';
            
            const city = document.getElementById('city');
            if (city) city.value = '';
        }

        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                if (!data.isAuthenticated) {
                    window.location.href = '/login.html';
                }
            } catch (error) {
                window.location.href = '/login.html';
            }
        }

        // Load shops
        async function loadShops() {
            try {
                const response = await fetch('/api/shops');
                const shops = await response.json();
                
                const shopsHtml = shops.map(shop => `
                    <tr class="fade-in">
                        <td style="width: 80px;">
                            <div class="d-flex align-items-center justify-content-center">
                                ${shop.imageUrl ? `
                                    <img src="${shop.imageUrl}" alt="${shop.name}" 
                                        class="rounded" 
                                        style="width: 60px; height: 60px; object-fit: cover; border: 1px solid #dee2e6;">
                                ` : `
                                    <div class="rounded bg-light d-flex align-items-center justify-content-center" 
                                        style="width: 60px; height: 60px; border: 1px solid #dee2e6;">
                                        <i class="bi bi-shop text-secondary fs-4"></i>
                                    </div>
                                `}
                            </div>
                        </td>
                        <td class="align-middle">${shop.name}</td>
                        <td class="align-middle">${shop.address}</td>
                        <td class="align-middle">${shop.city}</td>
                        <td class="align-middle">${shop.contactNumber}</td>
                        <td class="align-middle">
                            <div class="d-flex flex-column">
                                <small class="text-muted">Mon-Fri: ${shop.openingHours?.monday?.open || '09:00'} - ${shop.openingHours?.monday?.close || '17:00'}</small>
                                <small class="text-muted">Weekend: ${shop.openingHours?.saturday?.open || '09:00'} - ${shop.openingHours?.saturday?.close || '17:00'}</small>
                            </div>
                        </td>
                        <td class="align-middle">
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="editShop('${shop._id}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteShop('${shop._id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                document.getElementById('shops-table').innerHTML = shopsHtml;
            } catch (error) {
                console.error('Error loading shops:', error);
            }
        }

        // Edit shop
        async function editShop(id) {
            try {
                const response = await fetch(`/api/shops/${id}`);
                const shop = await response.json();
                
                document.getElementById('modalTitle').textContent = 'Edit Shop';
                document.getElementById('shopName').value = shop.name;
                document.getElementById('streetAddress').value = shop.address;
                document.getElementById('city').value = shop.city;
                document.getElementById('contactNumber').value = shop.contactNumber;
                
                // Set opening hours
                if (shop.openingHours?.monday) {
                    document.getElementById('openTime').value = shop.openingHours.monday.open;
                    document.getElementById('closeTime').value = shop.openingHours.monday.close;
                }
                if (shop.openingHours?.saturday) {
                    document.getElementById('weekendOpenTime').value = shop.openingHours.saturday.open;
                    document.getElementById('weekendCloseTime').value = shop.openingHours.saturday.close;
                }
                
                // Show existing image if available
                if (shop.imageUrl) {
                    const preview = document.getElementById('imagePreview');
                    const img = preview.querySelector('img');
                    img.src = shop.imageUrl;
                    preview.classList.remove('d-none');
                }
                
                // Geocode the address and update map
                geocoder.geocode({ address: `${shop.address}, ${shop.city}` }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        map.setCenter(location);
                        map.setZoom(15);
                        marker.position = location;
                    }
                });
                
                currentShopId = id;
                shopModal.show();
            } catch (error) {
                console.error('Error loading shop:', error);
            }
        }

        // Delete shop
        async function deleteShop(id) {
            if (confirm('Are you sure you want to delete this shop?')) {
                try {
                    await fetch(`/api/shops/${id}`, { method: 'DELETE' });
                    loadShops();
                } catch (error) {
                    console.error('Error deleting shop:', error);
                }
            }
        }

        // Save shop
        document.getElementById('saveShopBtn').addEventListener('click', async () => {
            const spinner = document.querySelector('.spinner-border');
            const errorAlert = document.getElementById('errorAlert');
            
            // Validate form
            const form = document.getElementById('shopForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            try {
                spinner.classList.remove('d-none');
                errorAlert.classList.add('d-none');

                // Get form data
                const name = document.getElementById('shopName').value.trim();
                const address = document.getElementById('streetAddress').value.trim();
                const city = document.getElementById('city').value.trim();
                const contactNumber = document.getElementById('contactNumber').value.trim();
                const openTime = document.getElementById('openTime').value;
                const closeTime = document.getElementById('closeTime').value;
                const weekendOpenTime = document.getElementById('weekendOpenTime').value;
                const weekendCloseTime = document.getElementById('weekendCloseTime').value;
                const imageFile = document.getElementById('shopImage').files[0];

                // Validate required fields
                if (!name) throw new Error('Shop name is required');
                if (!address) throw new Error('Street address is required');
                if (!city) throw new Error('City is required');
                if (!contactNumber) throw new Error('Contact number is required');

                // Get marker position
                const position = marker.getPosition();
                if (!position) throw new Error('Please select a location on the map');

                // Get lat/lng as numbers
                const lat = position.lat();
                const lng = position.lng();
                
                // Validate coordinates
                if (typeof lat !== 'number' || typeof lng !== 'number' || isNaN(lat) || isNaN(lng)) {
                    throw new Error('Invalid location coordinates');
                }
                
                // Create shop data object
                const shopData = {
                    name,
                    address,
                    city,
                    contactNumber,
                    location: {
                        lat: lat,
                        lng: lng
                    },
                    openingHours: {
                        monday: { open: openTime, close: closeTime },
                        tuesday: { open: openTime, close: closeTime },
                        wednesday: { open: openTime, close: closeTime },
                        thursday: { open: openTime, close: closeTime },
                        friday: { open: openTime, close: closeTime },
                        saturday: { open: weekendOpenTime, close: weekendCloseTime },
                        sunday: { open: weekendOpenTime, close: weekendCloseTime }
                    }
                };

                console.log('Sending shop data with location:', shopData); // Debug log

                // Create FormData
                const formData = new FormData();
                formData.append('data', JSON.stringify(shopData));
                if (imageFile) {
                    formData.append('image', imageFile);
                }

                const url = currentShopId ? `/api/shops/${currentShopId}` : '/api/shops';
                const method = currentShopId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Server error response:', errorData);
                    throw new Error(errorData.message || errorData.error || 'Failed to save shop');
                }

                const data = await response.json();
                console.log('Server response:', data);

                // Show success message
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show';
                successAlert.innerHTML = `
                    <strong>Success!</strong> Shop has been ${currentShopId ? 'updated' : 'created'} successfully.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Insert the alert before the card
                const card = document.querySelector('.card');
                const container = card.parentElement;
                container.insertBefore(successAlert, card);

                shopModal.hide();
                loadShops();
                resetForm();

                // Remove success message after 3 seconds
                setTimeout(() => {
                    successAlert.remove();
                }, 3000);
            } catch (error) {
                console.error('Error saving shop:', error);
                errorAlert.textContent = error.message || 'An error occurred while saving the shop';
                errorAlert.classList.remove('d-none');
            } finally {
                spinner.classList.add('d-none');
            }
        });

        // Reset form
        function resetForm() {
            const form = document.getElementById('shopForm');
            form.reset();
            form.classList.remove('was-validated');
            document.getElementById('modalTitle').textContent = 'Add New Shop';
            document.getElementById('errorAlert').classList.add('d-none');
            document.getElementById('locationSearch').value = '';
            document.getElementById('streetAddress').value = '';
            document.getElementById('city').value = '';
            document.getElementById('imagePreview').classList.add('d-none');
            currentShopId = null;
            
            // Reset map
            resetMap();
        }

        // Handle image preview
        document.getElementById('shopImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    const img = preview.querySelector('img');
                    img.src = e.target.result;
                    preview.classList.remove('d-none');
                }
                reader.readAsDataURL(file);
            }
        });

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await fetch('/api/auth/logout');
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Error logging out:', error);
            }
        });
    </script>
</body>
</html> 